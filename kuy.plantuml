@startuml
actor User
participant BoardGameCafe
participant ReservationManager
participant Reservation
participant Payment
participant AuditLog

User -> BoardGameCafe: request_cancel(reservation_id)
activate BoardGameCafe

BoardGameCafe -> ReservationManager: find_reservation(reservation_id)
activate ReservationManager
ReservationManager -> ReservationManager: loop through __reservations
activate ReservationManager
deactivate ReservationManager
ReservationManager --> BoardGameCafe: reservation
deactivate ReservationManager

alt reservation not found
    BoardGameCafe --> User: raise Exception("Reservation not found")
else reservation found
    BoardGameCafe -> ReservationManager: cancel_reservation(reservation)
    activate ReservationManager
    
    ReservationManager -> ReservationManager: calculate_remaining_hours(reservation)
    activate ReservationManager
    ReservationManager -> Reservation: get_date()
    activate Reservation
    Reservation --> ReservationManager: date
    deactivate Reservation
    ReservationManager --> ReservationManager: remaining_hours
    deactivate ReservationManager
    
    ReservationManager -> Reservation: set_status("cancelled")
    activate Reservation
    deactivate Reservation
    
    alt remaining_hours >= 3
        ReservationManager -> Reservation: get_deposit()
        activate Reservation
        Reservation --> ReservationManager: deposit
        deactivate Reservation
        
        ReservationManager -> Payment: refund_full_deposit(deposit)
        activate Payment
        Payment --> ReservationManager: refund_amount
        deactivate Payment
        
        ReservationManager -> Reservation: get_id()
        activate Reservation
        Reservation --> ReservationManager: reservation_id
        deactivate Reservation
        
        ReservationManager -> AuditLog: record_full_refund(reservation_id)
        activate AuditLog
        deactivate AuditLog
        
        ReservationManager --> BoardGameCafe: ("full_refund", refund_amount)
        
    else remaining_hours < 3
        ReservationManager -> Reservation: get_deposit()
        activate Reservation
        Reservation --> ReservationManager: deposit
        deactivate Reservation
        
        ReservationManager -> Payment: apply_penalty(deposit)
        activate Payment
        Payment --> ReservationManager: refund_amount
        deactivate Payment
        
        ReservationManager -> Reservation: get_id()
        activate Reservation
        Reservation --> ReservationManager: reservation_id
        deactivate Reservation
        
        ReservationManager -> AuditLog: record_penalty(reservation_id)
        activate AuditLog
        deactivate AuditLog
        
        ReservationManager --> BoardGameCafe: ("penalty", refund_amount)

    end
    
    deactivate ReservationManager
    
    BoardGameCafe -> ReservationManager: remove_reservation(reservation)
    activate ReservationManager
    ReservationManager -> ReservationManager: __reservations.remove(reservation)
    activate ReservationManager
    deactivate ReservationManager
    deactivate ReservationManager
    
    BoardGameCafe -> Reservation: __del__()
    activate Reservation
    note right: Reservation deleted
    deactivate Reservation
    
    BoardGameCafe --> User: (result, refund_amount)
end

deactivate BoardGameCafe
@enduml